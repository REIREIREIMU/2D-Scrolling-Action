#include "GameScene.h"
#include "DxLib.h"
#include "SceneManager.h"
#include "Input.h"

#include <algorithm>

// アイテム種類をランダムで返す
int GetRandomItemType() {
	return GetRand(4);  // 0〜4 のアイテム番号
}

// 体型ごとの評価スコア
int GetFatScore(FatState fat) {
	switch (fat) {
	case FatState::Thin:
	case FatState::SlightlyThin:
	case FatState::Normal:   return 200;
	case FatState::SlightlyFat: return 600;
	case FatState::Fat1:     return 1000;
	case FatState::Fat2:     return 1500;
	case FatState::Fat3:     return 3000;
	case FatState::Fat4:     return 8000;
	}
	return 0;
}

/*
   マップ記号の例
   '#' = 壁
   'I' = アイテム
   'E' = 敵
   'P' = プレイヤー初期位置
*/

const std::vector<std::string> mapText_stage1 = {
	// "                                                                                                                                                                                                                             ",
	// "                                                                                                                                                                                                                             ",
	// "                                                                                                                                                                                                                             ",
	// "                                                                                                                                                                                                                             ",
	// "                                                                                                                                                                                                                             ",
	// "                                                                                                                                                                                                                             ",
	// "                                                                                                                                                                                                                             ",
	// "                                                                                                                                                                                                                             ",
	// "                                                                                                                                                                                                                             ",
	// "                                                                                                                                                                                                                             ",
	// "																																																							   ",
	// "																																																							   ",
	// "											   																																						                           ",
	// " 										                                                 																															           ",
	// "     　       　　                                                                                                                                                                                                           ",
	// "     P      		                                                                                                                                                                                                           ",
	// "wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww   wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww                   wAw",//Aタイプの敵は最後の個体を倒すと警告文が出るためここに置く
	// "=============================================================================================================================================   =============================================================================                   ==="
	////0         1         2         3         4         5         6         7         8         9         A         B         C         D         E         F        10        11        12        13        14        15        16         7         8         9
	//上の数は10マスごとに16進数で数えられている

	////α(拡張版)ステージ
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                   $   ",
	// "                                                                                                   2  1  3  2                                                                                                                                         C                                            1    5          $   ",
	// "                      ?                                                                           ###########?                                            ?                                                        4      5                         ?###?                                     2                    $   ",
	// "                                    2    4      3   1                                                                                                                                                                                                                                    3            C            $   ",
	// "                                                                                        ?    ?                                        3                                                                                                                                 2           4                ##            $   ",
	// "                                                                      3                                                                                                                        1                                                  B      B                                  B   ##   ##            $   ",
	// "           1 2 1    #?#?#                   //               ?     1     5            1  2  3  4               3  4                                     ?###?                21                ###?            ##     ##     ##          2   3   ?#########?                               ##   ##   ##            $   ",
	// "                                //          //         //                            /##########/                            /   /         //   /                 //       3    5       //                                          //                               //   /           ##   ##   ##   ##            $   ",
	// "      　　         　　         //          //         //                           //          //                          //   //       ///   //                //                    //              //                          //                              ///   //     ##   ##   ##   ##   ##            $   ",
	// "     P                      A   //          //    A    //    B                     ///          ///        A   B   A       ///   ///     ////   ///     A   A     //   B            B   //        A     //  B 1  5 C 3  2 C 2  5  B //           A    A    A       //// C ///    ##   ##      A    A    A         ///  ",
	// "====================================================================     ====================================================================   ============================    ==============================####===####===####=======================================================================================",
	// "====================================================================     ====================================================================   ============================    ==============================    ===    ===    ======================================================================================="
	// //0   P     1         2         3         4         5         6         7         8         9         A         B         C         D         E         F        10        11        12        13        14        15        16        17        18        19        1A        1B        1C        1D        1E        1F
	// //上の数は10マスごとに16進数で数えられている

	////βステージ
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                       ",
	// "                                                                                                                                                                                                                                                                                                                  $    ",
	// "                            2                                                                                              2  1  3  2                                                                                                                  C                                            1             $    ",
	// "              1            3 1                                      3    4                                                ###########?                                                                              4      5                         ?###?                                     2                  $    ",
	// "                                                                                                                                                        4       5                                                                                                        2                3            C          $    ",
	// "                                                               1              5                                 ?    ?                                                                                                                                                               4                ##          $    ",
	// "                                                     5                                        2                                                             C            2                                                                          B     B                                  B   ##   ##          $    ",
	// "            #?#?#          ###                    ?#####?             //                   1     4            1  2  3  4             ##?##                 ###           ####?       3 1       ?????            ##     ##     ##          2   3   ?#########?                               ##   ##   ##          $    ",
	// "                      //         //                                   //         B                           /##########/                            /             /               /#####/                                           //                               //   /           ##   ##   ##   ##          $    ",
	// "      　　          　//         //                         //        //        //                          //          //                          //             //             //#####//              //                          //                              ///   //     ##   ##   ##   ##   ##          $    ",
	// "     P                //    4    //               A         //        //    A   //                         ///          ///        A   B   A       ///      3      ///     A     ///#####///             //    1  5 C      C 2  5    //           A    A    A       //// C ///    ##   ##      A    A    A       ///   ",
	// "wwwwwwwwwwwwwwwwwwwwwwwwwww   wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww     wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww###wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww####www####www####wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww                 wAw",//Aタイプの敵は最後の個体を倒すと警告文が出るためここに置く
	// "===========================   ==============================================================     ==========================================================   =================================================    ===    ===    ======================================================================================                 ==="
	////0   P     1         2         3         4         5         6         7         8         9         A         B         C         D         E         F        10        11        12        13        14        15        16        17        18        19        1A        1B        1C        1D        1E        1F
	////

	//βステージ1(難易度調整板)
	 "                                                                                                                                                                                                                                                                                           ",
	 "                                                                                                                                                                                                                                                                                           ",
	 "                                                                                                                                                                                                                                                                                           ",
	 "                                                                                                                                                                                                                                                                                           ",
	 "                                                                                                                                                                                                                                                                                           ",
	 "                                                                                                                                                                                                                                                                                           ",
	 "                                                                                                                                                                                                                                                                                      $    ",
	 "                            2                                                                                              2  1  3  2                                                                                      C                                            1             $    ",
	 "              1            3 1                                      3    4                                                ###########?                                                          1 2                      ?###?                                     2                  $    ",
	 "                                                                                                                                                        4       5                                                                            2                3            C          $    ",
	 "                                                               1              5                                 ?    ?                                                                                                                                   4                ##          $    ",
	 "                                                     5                                        2                                                             C            2                                              B     B                                  B   ##   ##          $    ",
	 "            #?#?#          ###                    ?#####?             //                   1     4            1  2  3  4             ##?##                 ###           ####?       3 1       ?????          2   3   ?#########?                               ##   ##   ##          $    ",
	 "                      //         //                                   //                                     /##########/                            /             /               /#####/               //                               //   /           ##   ##   ##   ##          $    ",
	 "      　　          　//         //                         //        //        //                          //          //                          //             //             //#####//              //                              ///   //     ##   ##   ##   ##   ##          $    ",
	 "     P                //    4    //  444444             A         //        //    A   //   B                     ///          ///        A   B   A       ///      3      ///     A     ///#####///       A     //           A    A    A       //// C ///    ##   ##      A    A    A       ///   ",
	 "wwwwwwwwwwwwwwwwwwwwwwwwwww   wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww     wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww###wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww                 wAw",//Aタイプの敵は最後の個体を倒すと警告文が出るためここに置く
	 "===========================   ==============================================================     ==========================================================   ==============================================================================================================================                 ==="
	 //0   P     1         2         3         4         5         6         7         8         9         A         B         C         D         E         F        10        11        12        13        14        15        16        17        18        19        1A        1B        1C        1D        1E        1F

   ////βステージ2
	 //"                                                                                                                                                                                                                             ",
	 //"                                                                                                                                                                                                                             ",
	 //"                                                                                                                                                                                                                             ",
	 //"                                                                                                                                                                                                                             ",
	 //"                                                                                                                                                                                                                             ",
	 //"                                                                                                                                                                                                                             ",
	 //"                                                                                                                                                         ??                                                            $     ",
	 //"                 B                                                                                                                                                                                                     $     ",
	 //"               ?###?            1   5                                                                                                                                                                                  $     ",
	 //"                                                                                             2      1            1       2                             1    2                                           1              $     ",
	 //"                                                                                                                                                       ######                                                          $     ",
	 //"                                                  1     4                   5                                                                   B      ######   1              1    2    4                             $     ",
	 //"           ?###?   ?###?    3    / /             ###   ###               ?#####?                    B          ?###?   ?###?                 #######           ###     ?     /////     /////   2 3 1            ##     $     ",
	 //"                               / / / /     /                                              /#####//#####/                         /     ###   #######    1    4 ###                                    /   /?    ##     $     ",
	 //"                             / / / / /     /                   //                        //     //     //                       //     ###        ##   ########                                      //   /     ##     $     ",
	 //"     P                     / / / / / /  A  /  B   4  C  5   B  //        A  A  A        ///     //     //            C         ///     ### 1    2 ## C ########     B           B   C   B           /// C /     ##    ///    ",
	 //"wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww wwwwwwwwwwwwww###www###wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww     ww     wwwwwwwwwwww#####wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww   wwwwwwwwwwwwwww   wwwwwwwwwwwwwwwwwwwwwwwwwwwwww                   wAw",//Aタイプの敵は最後の個体を倒すと警告文が出るためここに置く
	 //"================================== ==============   ===   =================================     ==     ============     ==================================================   ===============   ==============================                   ==="
	 ////0   P     1         2         3         4         5         6         7         8         9         A         B         C         D         E         F        10        11        12        13        14        15        16        17        18        19        1A        1B        1C        1D        1E        1F
	 //    

   ////βステージ3
//"                                                                                                                                                                                                                                                                             ",
//"                                                                                                                                                                                                                                                                             ",
//"                                                    1   3   4   4   1   2   5                                                                                                                                                                                                ",
//"                                            ?       /###/###/###/###/###/###/                                                                                                                                                                                                ",
//"                             1                                                                               ? ? ?                                                                                                                                                           ",
//"                                                                                                                                                                                                                                                                             ",
//"                                                              2                                                                                                               2                                                                                        $     ",
//"                                           ?#?                                                                                                                          1    5 3    4                                  C                                               $     ",
//"                            www                                           ?                                 ?#####?                                                                                                  ?###?                                  2 B 1      $     ",
//"                            ===                                   1                                                                                                                                                                                         /////      $     ",
//"                    ?        =              B           wwww                                                                              4      2                                                   3                                   1      1   2                  $     ",
//"                                       5  wwwww  2      ====              B          1   5   3              B     B                                                   ?###?       ?###?                   1         B     B         3           wwwww                  $     ",
//"            /                        wwwww=====wwwww              C     wwwww                            #wwwwwwwwwww                                    ?##?                                                  3  ?#########?  4                =====                  $     ",
//"     P     //                        ===============             www    =====                       www### ==========wwww                                                                       www                                     www      ===                   $     ",
//"wwwwwwwwww///     wwwww      B        ===       ===              ===     ===                     www===#                =wwww         ww     ww     ww                  B     B     B           ===wwwww  B                            w===                 #####      $     ",
//"==========www     =====     www                                                   wwwwwwwwwwwwwww======                  ====wwww    w==w C w==w C w==w            wwwwwwwwwwwwwwwwwwwwwww       =======wwwww     A    A    A     wwwww====                           ///    ",
//"=============      ===      ===                                                   ======================= 1 2A3 4A5 =============wwww====www====www====wwwwwwww    =======================          =========wwwwwwwwwwwwwwwwwwwww=========             C             wwwwwwww                        wAw",//Aタイプの敵は最後の個体を倒すと警告文が出るためここに置く
//"=============                =                                                    =============================================================================     =====================                ==================================             #             ========                        ==="
////0   P     1         2         3         4         5         6         7         8         9         A         B         C         D         E         F        10        11        12        13        14        15        16        17        18        19        1A        1B        1C        1D        1E        1F
////    

};

const std::vector<std::string> mapText_stage2 = {
	//βステージ2
	"                                                                                                                                                                                                                             ",
	"                                                                                                                                                                                                                             ",
	"                                                                                                                                                                                                                             ",
	"                                                                                                                                                                                                                             ",
	"                                                                                                                                                                                                                             ",
	"                                                                                                                                                                                                                             ",
	"                                                                                                                                                         ??                                                            $     ",
	"                 B                                                                                                                                                                                                     $     ",
	"               ?###?            1   5                                                                                                                                                                                  $     ",
	"                                                                                             2      1            1       2                             1    2                                           1              $     ",
	"                                                                                                                                                       ######                                                          $     ",
	"                                                  1     4                   5                                                                   B      ######   1              1    2    4                             $     ",
	"           ?###?   ?###?    3    / /             ###   ###               ?#####?                    B          ?###?   ?###?                 #######           ###     ?     /////     /////   2 3 1   ?       ?##     $     ",
	"                               / / / /     /                                              /#####//#####/                         /     ###   #######    1    4 ###                                    /         ##     $     ",
	"                             / / / / /     /                   //                        //     //     //                       //     ###        ##   ########                                      //         ##     $     ",
	"     P                     / / / / / /  A  /  B   4  C  5   B  //        A  A  A        ///     //     //            C         ///     ### 1    2 ## C ########     B           B   C   B           ///    A    ##    ///    ",
	"wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww wwwwwwwwwwwwww###www###wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww     ww     wwwwwwwwwwww#####wwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwwww   wwwwwwwwwwwwwww   wwwwwwwwwwwwwwwwwwwwwwwwwwwwww                   wAw",//Aタイプの敵は最後の個体を倒すと警告文が出るためここに置く
	"================================== ==============   ===   =================================     ==     ============     ==================================================   ===============   ==============================                   ==="
	//0   P     1         2         3         4         5         6         7         8         9         A         B         C         D         E         F        10        11        12        13        14        15        16        17        18        19        1A        1B        1C        1D        1E        1F
	//    
};

const std::vector<std::string> mapText_stage3 = {
	//βステージ3
	"                                                                                                                                                                                                                                                                             ",
	"                                                                                                                                                                                                                                                                             ",
	"                                                    1   3   4   4   1   2   5                                                                                                                                                                                                ",
	"                                            ?       /###/###/###/###/###/###/                                                                                                                                                                                                ",
	"                             1                                                                               ? ? ?                                                                                                                                                           ",
	"                                                                                                                                                                                                                                                                             ",
	"                                                              2                                                                                                               2                                                                                        $     ",
	"                                           ?#?                                                                                                                          1    5 3    4                                  C                                               $     ",
	"                            www                                           ?                                 ?#####?                                                                                                  ?###?                                  2 B 1      $     ",
	"                            ===                                   1                                                                                                                                                                                         /////      $     ",
	"                    ?        =              B           wwww                                                                              4      2                                                   3                                   1      1   2                  $     ",
	"                                       5  wwwww  2      ====              B          1   5   3              B     B                                                   ?###?       ?###?                   1         B     B         3           wwwww                  $     ",
	"            /                        wwwww=====wwwww              C     wwwww                            #wwwwwwwwwww                                    ?##?                                                  3  ?#########?  4                =====                  $     ",
	"     P     //                        ===============             www    =====                       www### ==========wwww                                                                       www                                     www      ===                   $     ",
	"wwwwwwwwww///     wwwww      B        ===       ===              ===     ===                     www===#                =wwww         ww     ww     ww                  B     B     B           ===wwwww  B                            w===                 #####      $     ",
	"==========www     =====     www                                                   wwwwwwwwwwwwwww======                  ====wwww    w==w C w==w C w==w            wwwwwwwwwwwwwwwwwwwwwww       =======wwwww     A    A    A     wwwww====                           ///    ",
	"=============      ===      ===                                                   ======================= 1 2A3 4A5 =============wwww====www====www====wwwwwwww    =======================          =========wwwwwwwwwwwwwwwwwwwww=========             C             wwwwwwww                        wAw",//Aタイプの敵は最後の個体を倒すと警告文が出るためここに置く
	"=============                =                                                    =============================================================================     =====================                ==================================             #             ========                        ==="
	//0   P     1         2         3         4         5         6         7         8         9         A         B         C         D         E         F        10        11        12        13        14        15        16        17        18        19        1A        1B        1C        1D        1E        1F
	//    

};

void GameScene::Init() {

	// ステージごとにmapTextを切り替える
	const std::vector<std::string>* stageMap = nullptr;

	if (stageNo == 1) {
		stageMap = &mapText_stage1;
	}
	else if (stageNo == 2) {
		stageMap = &mapText_stage2;
	}
	else if (stageNo == 3) {
		stageMap = &mapText_stage3;
	}

	scrollX = 0;
	endFlag = false;
	nextSceneID = 0;

	score = 0;
	timeLimit = 300; // 5分

	soundvolume_ = 128;

	// ブロック画像の読み込み
	blockImages[(int)BlockType::GroundA] = LoadGraph("image/GroundA.png");
	blockImages[(int)BlockType::GroundB] = LoadGraph("image/GroundB.png");
	blockImages[(int)BlockType::Brick] = LoadGraph("image/Block.png");
	blockImages[(int)BlockType::Question_Empty] = LoadGraph("image/Question_Empty.png");

	blockImages[(int)BlockType::Goal] = LoadGraph("image/Goal.png");

	// ？ブロック用は3枚の連番画像を読み込む
	int questionImgs[3];
	questionImgs[0] = LoadGraph("image/Question_Block_1.png");
	questionImgs[1] = LoadGraph("image/Question_Block_2.png");
	questionImgs[2] = LoadGraph("image/Question_Block_3.png");
	Block::SetQuestionBlockImages(questionImgs, 3);

	//　サウンドの読み込み
	Eat_Sound = LoadSoundMem("sound/Eat.mp3");
	BreakBrick_Sound = LoadSoundMem("sound/BreakBrick.mp3");
	Activate_Sound = LoadSoundMem("sound/Activate.mp3");
	Kill_Sound_1 = LoadSoundMem("sound/collapse.mp3");
	Kill_Sound_2 = LoadSoundMem("sound/collapse.mp3");

	Main_Bgm = LoadSoundMem("sound/MainBGM.mp3");

	//BGMを再生
	PlaySoundMem(Main_Bgm, DX_PLAYTYPE_LOOP);
	ChangeVolumeSoundMem(soundvolume_, Main_Bgm);

	// マップデータから各オブジェクトリストを取得

	// 1. マップ読み込み
	//map.LoadFromString(mapText, blockImages);
	map.LoadFromString(*stageMap, blockImages);

	// 2. ブロック配置（プレイヤーより先）
	{
		blocks = map.blocks;    //壁のオブジェクトリスト

		//レンガ破片画像を読み込み
		int brickPieceImages[2];
		brickPieceImages[0] = LoadGraph("image/brick_piece1.png");
		brickPieceImages[1] = LoadGraph("image/brick_piece2.png");

		Block::SetBrickPieceImages(brickPieceImages, 2);

	}

	// 3. プレイヤー初期化
	player.Init(map.playerStart);

	player.SetBlockImages(blockImages);

	items = map.items;      //アイテムのオブジェクトリスト
	enemies = map.enemies;  //敵のオブジェクトリスト
	itemCollected = std::vector<bool>(items.size(), false);

	enemyImages =       //敵の描画ファイルの読み込み
	{
		 LoadGraph("image/Enemy1_Walk_L.png"),
		 LoadGraph("image/Enemy1_Walk_R.png"),
		 LoadGraph("image/Enemy2_Walk_L.png"),
		 LoadGraph("image/Enemy2_Walk_R.png"),
		 LoadGraph("image/Enemy3_Normal.png"),
		 LoadGraph("image/Enemy3_Ready.png"),
		 LoadGraph("image/Enemy3_Attack.png"),
		 LoadGraph("image/Enemy4.png")
	};

	itemImages = {       //アイテムがの描画ファイルの読み込み
	   LoadGraph("image/Food1.png"),
	   LoadGraph("image/Food2.png"),
	   LoadGraph("image/Food3.png"),
	   LoadGraph("image/Food4.png"),
	   LoadGraph("image/Food5.png")
	};

	//ステージの描画ファイルの読み込み
	backgroundImage = LoadGraph("image/background.png");

	player.SetBlockImages(blockImages);

	//主人公死亡エフェクト用
	deathEffectImg = LoadGraph("image/Explosion.png");// 爆発画像1枚 or アニメシート
	deathEffectFrame = 0;
	isDeathEffectActive = false;

	// 爆発スプライトのコマサイズを取得
	int imgW, imgH;
	GetGraphSize(deathEffectImg, &imgW, &imgH);
	deathEffectCols = 3; // 横3コマ
	deathEffectRows = 4; // 縦4コマ
	deathEffectFrameW = imgW / deathEffectCols;
	deathEffectFrameH = imgH / deathEffectRows;

	//主人公死亡サウンド用
	Death_Sound = LoadSoundMem("sound/Explosion.mp3");
	
	// 敵アニメーション画像をセット
	//std::vector<int> enemyWalkAnim = { enemyImages[0], enemyImages[1] };

	for (auto& enemy : enemies) {
		if (enemy.type == 0) {
			enemy.SetAnimImages({ enemyImages[0], enemyImages[1] });  // Enemy1
		}
		else if (enemy.type == 1) {
			enemy.SetAnimImages({ enemyImages[2], enemyImages[3] });  // Enemy2
		}
		else if (enemy.type == 2) {
			// type 2 は個別画像をセット
			enemy.enemy3NormalImg_ = enemyImages[4]; // Enemy3_Normal.png
			enemy.enemy3ReadyImg_ = enemyImages[5];  // Enemy3_Ready.png
			enemy.enemy3AttackImg_ = enemyImages[6]; // Enemy3_Attack.png
		}

	}

	//UI関係
	UI_Score = LoadGraph("image/Score.png");		//スコアの画像
	//UI_Bar_Case = LoadGraph("image/Bar_Case.png");		//バーの枠の画像
	UI_Timer = LoadGraph("image/Timer.png");		//タイマーの画像
	UI_Player_Lives = LoadGraph("image/Player_Lives.png");	//残機表示の画像

}

// SceneBase から呼ばれる Update（引数なし）
void GameScene::Update() {
	Update(deltaTimeForUpdate); // 内部で渡す
}

// deltaTime付きの本来のUpdate
void GameScene::Update(/*float*/ double deltaTime) {

	// deltaTime をセット
	deltaTimeForUpdate = deltaTime;

	////BGMを再生
	//PlaySoundMem(Main_Bgm, DX_PLAYTYPE_LOOP);
	////ChangeVolumeSoundMem(soundvolume_ * 2, Main_Bgm);

	// 制限時間を減少
	timeLimit -= deltaTime;
	if (timeLimit <= 0) {
		// 時間切れ → ゲームオーバー
		player.isDead = true;

		timeLimit = 0;
	}

	// プレイヤーの更新
	player.Update(blocks, deltaTime);

	// プレイヤーの矩形を取得（敵に渡す）
	Rect playerRect = player.GetRect();

	// 死亡後、2秒経過でゲームオーバーへ
	if (player.IsDead()) {

		//BGM止める
		StopSoundMem(Main_Bgm);

		// エフェクト開始（1回だけ）
		if (!isDeathEffectActive) {
			isDeathEffectActive = true;

			deathEffectFrame = 0;
			effectX = playerRect.x + playerRect.w / 2 - deathEffectFrameW / 2;
			effectY = playerRect.y + playerRect.h / 2 - deathEffectFrameH / 2;

			//死亡効果音を再生
			PlaySoundMem(Death_Sound, DX_PLAYTYPE_BACK);
			ChangeVolumeSoundMem(soundvolume_, Death_Sound);

		}

		// エフェクト進行
		//if (isDeathEffectActive) {
		int totalFrames = deathEffectCols * deathEffectRows; // 9コマ
		if (deathEffectFrame < totalFrames * 5 - 1) {
			deathEffectFrame++;
		}

		// アニメーション終了 → エフェクトを止める
		//isDeathEffectActive = false;

		//一定時間待つ（例: 2秒）
		if (player.deathTimer > 2.0f) {
			player.LoseLife();       // 残機を減らす

			if (player.GetLives() > 0) {
				nextSceneID = 1; // ReadyScene に遷移
			}
			else {
				nextSceneID = 2; // GameOverScene に遷移
				
			}
			endFlag = true;
		}
		//return; // 死亡中は他処理スキップ

	//// 死亡エフェクト開始（1回のみ）
		//if (!isDeathEffectActive) {
		//	isDeathEffectActive = true;
		//	deathEffectFrame = 0;
		//	effectX = playerRect.x + playerRect.w / 2 - deathEffectFrameW / 2;
		//	effectY = playerRect.y + playerRect.h / 2 - deathEffectFrameH / 2;
		//}
		//return;

	}

	//敵の更新（移動処理）
	for (auto& enemy : enemies) {

		//// 敵本体と接触
		//if (playerRect.Intersects(enemy.rect)) {
		//	player.isDead = true;
		//}

		// 敵弾との接触
		for (const auto& bullet : enemy.GetBullets()) {
			if (playerRect.Intersects(bullet.GetRect())) {
				player.isDead = true;
			}
		}

		//// 死亡後、2秒経過でゲームオーバーへ
		//if (player.IsDead()) {

		//	// エフェクト開始（1回だけ）
		//	if (!isDeathEffectActive) {
		//		isDeathEffectActive = true;
		//		deathEffectFrame = 0;
		//		effectX = playerRect.x + playerRect.w / 2 - deathEffectFrameW / 2;
		//		effectY = playerRect.y + playerRect.h / 2 - deathEffectFrameH / 2;
		//	}

		//	// エフェクト進行
		//	int totalFrames = deathEffectCols * deathEffectRows;
		//	if (deathEffectFrame < totalFrames * 5 - 1) {
		//		deathEffectFrame++;
		//	}

		//	// 一定時間待つ（例: 2秒）
		//	if (player.deathTimer > 2.0f) {
		//		player.LoseLife();       // 残機を減らす
		//		if (player.GetLives() > 0) {
		//			nextSceneID = 1; // ReadyScene に遷移
		//		}
		//		else {
		//			nextSceneID = 2; // GameOverScene に遷移
		//		}
		//		endFlag = true;
		//	}
		//	return; // 死亡中は他処理スキップ

		//	//// 死亡エフェクト開始（1回のみ）
		//	//if (!isDeathEffectActive) {
		//	//	isDeathEffectActive = true;
		//	//	deathEffectFrame = 0;
		//	//	effectX = playerRect.x + playerRect.w / 2 - deathEffectFrameW / 2;
		//	//	effectY = playerRect.y + playerRect.h / 2 - deathEffectFrameH / 2;
		//	//}
		//	//return;
		//}

			//画面内の敵だけ更新
		bool isOnScreen =
			enemy.rect.x + enemy.rect.w > scrollX &&
			enemy.rect.x < scrollX + SCREEN_WIDTH &&
			enemy.rect.y + enemy.rect.h > 0 &&
			enemy.rect.y < SCREEN_HEIGHT;

		if (!isOnScreen && enemy.type != 2) continue;

		enemy.Update(blocks, enemies, playerRect, scrollX, deltaTime);
	}

	// プレイヤーの頭位置の矩形
	Rect footRect = playerRect;
	footRect.y += playerRect.h;  // 足元をわずかに下にオフセット
	footRect.h = 5;   // 足の高さ（ヒット判定用）

	// プレイヤーの頭部矩形を作る
	Rect headRect = playerRect;
	headRect.h = 5;             // 頭の高さは小さめ
	headRect.y -= 5;            // 頭の上に少しオフセット

	//敵全員更新
	//enemy.Update(blocks, enemies, player.GetRect());
	// 
	//ブロック更新と判定
	for (auto& block : blocks) {
		/*for (size_t i = 0; i < blocks.size(); ++i)
		{
			Block& block = blocks[i];*/

			//各ブロックの内部更新
		block.Update(deltaTimeForUpdate);

		//衝突のあるブロックのみ処理
		if (!block.HasCollision()) continue;

		//const Rect& b = block.GetRect();

		//上向きジャンプ中に？ブロックと接触
		if (headRect.Intersects(block.GetRect()) &&
			block.GetType() == BlockType::Question &&
			!block.IsActivated())
		{
			block.Activate();

			// ブロックの種類を地面Bに変更
			block.SetType(BlockType::Question_Empty);
			block.SetImage(blockImages[(int)BlockType::Question_Empty]);

			// アイテムを出す
			//items.push_back({ { b.x, b.y - b.h, b.w, b.h }, GetRandomItemType() });
			items.push_back({ { block.GetRect().x, block.GetRect().y - block.GetRect().h, block.GetRect().w, block.GetRect().h }, GetRandomItemType() });
			itemCollected.push_back(false);

			//木箱破壊時の効果音を再生
			PlaySoundMem(Activate_Sound, DX_PLAYTYPE_BACK);
			ChangeVolumeSoundMem(soundvolume_,Activate_Sound);

		}

		// レンガブロック破壊判定
		FatState fat = player.GetFatState();

		//肥満体型をboolで一括り
		bool isFatEnough = (fat == FatState::Fat1 || fat == FatState::Fat2
			|| fat == FatState::Fat3 || fat == FatState::Fat4);

		if (isFatEnough &&
			/*footRect.Intersects(block.GetRect()) &&*/
			block.GetType() == BlockType::Brick)//)
		{
			// レンガブロックの上を歩いて or 上から乗っかったで破壊(予備)
			if (footRect.Intersects(block.GetRect()) ||
				playerRect.Intersects(block.GetRect()))
			{
				block.BreakBrick();

				score += 50; // スコア加算

				//レンガ破壊時の効果音を再生
				PlaySoundMem(BreakBrick_Sound, DX_PLAYTYPE_BACK);
				ChangeVolumeSoundMem(soundvolume_, BreakBrick_Sound);
			}
		}

	}


	// アイテム取得処理
	for (size_t i = 0; i < items.size(); ++i) {
		if (!itemCollected[i] && CheckCollision(playerRect, items[i].rect)) {
			itemCollected[i] = true;
			player.Grow(blocks);

			score += 100; // スコア加算

			//取得効果音を再生
			PlaySoundMem(Eat_Sound, DX_PLAYTYPE_BACK);
			ChangeVolumeSoundMem(soundvolume_, Eat_Sound);
		}
	}

	// スクロール位置更新
	scrollX = player.GetX() - SCREEN_WIDTH / 2;
	if (scrollX < 0) scrollX = 0;

	// 敵との当たり判定
	bool stomped = false;     //このフレームで1回でも踏んだらtrueにする

	// アイテムとの当たり判定などで使用
	for (size_t i = 0; i < enemies.size();)
	{
		const Rect& enemyRect = enemies[i].rect;
		//int enemyType = enemies[i].type;

		// プレイヤー矩形の取得
		//Rect playerRect = player.GetRect();

		// プレイヤーの底と敵の上辺の差
		int playerBottom = playerRect.y + playerRect.h;

		// 敵の頭（上辺）のY座標
		int enemyTop = enemyRect.y;

		// 上から踏んでいる判定（プレイヤーの足部分が敵の頭付近に位置）
		bool isVerticallyAbove =
			playerBottom > enemyTop &&               // プレイヤーが敵より下に入り込んでいて
			playerBottom < enemyTop + 22;            // (22px) 以内なら踏んだと判定

		// 横方向の重なりチェック
		bool isHorizontallyOverlapping =
			playerRect.x + playerRect.w > enemyRect.x &&
			playerRect.x < enemyRect.x + enemyRect.w;

		// 敵の上に乗って倒す（Enemy1 or Enemy2 or Enemy3限定）
		if ((enemies[i].type == 0 || enemies[i].type == 1 || enemies[i].type == 2) &&
			isHorizontallyOverlapping && isVerticallyAbove)
		{
			// 消す前に型を保存しておく（erase 後に参照しないように）
			int killedType = enemies[i].type;

			// 敵消滅
			enemies.erase(enemies.begin() + i);

			// プレイヤーが跳ねる
			player.Bounce();
			stomped = true;                      // 踏んだら true

			// スコア加算
			score += 200;

			// 音の再生は保存した killedType を使う
			if (killedType == 0 || killedType == 1)
			{
				PlaySoundMem(Kill_Sound_1, DX_PLAYTYPE_BACK);
				ChangeVolumeSoundMem(soundvolume_, Kill_Sound_1);
			}
			else if (killedType == 2)
			{
				PlaySoundMem(Kill_Sound_2, DX_PLAYTYPE_BACK);
				ChangeVolumeSoundMem(soundvolume_, Kill_Sound_2);
			}

			// erase したので i は増やさない（continueして次ループへ）
			continue;
		}

		// まだ踏んでいなければ、衝突判定（プレイヤー死亡）
		if (!stomped && CheckCollision(playerRect, enemyRect)) {
			player.isDead = true;
		}

		++i;
	}

	// ゴール判定
	for (const auto& block : blocks) {
		if (block.GetType() == BlockType::Goal && playerRect.Intersects(block.GetRect())) {
			// クリア時のスコア加算
			//score += (int)timeLimit * 10;        // 残り時間
			//score += player.GetLives() * 1000;   // 残機
			//score += GetFatScore(player.GetFatState()); // 体型評価
	
			if (!isGoalFade) { // 初回だけ処理

				StopSoundMem(Main_Bgm);

				SceneManager::SetResultScore(score);             // ゲーム中のスコア
				SceneManager::SetTimeBonus((int)timeLimit * 10); // 残り時間ボーナス

				//SceneManager::SetLifeBonus(player.GetLives() * 1000); // 残機ボーナス
				SceneManager::SetLifeBonus(playerLives * 1000); // 残機ボーナス

				SceneManager::SetBodyBonus(GetFatScore(player.GetFatState())); // 体型評価ボーナス

				// ClearSceneにスコアを渡す
				//auto clearScene = new ClearScene();
				//clearScene->SetScore(score);
				//SceneManager::GetInstance().ChangeScene(clearScene);


				//ClearSceneに渡すスコアをSceneManagerに保存
				SceneManager::SetResultScore(score);

				isGoalFade = true;   // フェード開始
				fadeAlpha = 0;
			}
			//endFlag = true;

			//nextSceneID = 3; // ClearScene に遷移
			//return;
		}
	}

	// フェード処理
	if (isGoalFade) {

		player.SetInvincible(true);
		player.SetControllable(false);

		fadeAlpha += 4; // 1フレームで暗くなる量（調整可）
		if (fadeAlpha >= 255) {
			fadeAlpha = 255;
			endFlag = true;

			nextSceneID = 3; // ClearScene に遷移
			//return;
		}
	}

	// ESCで強制終了
	if (CheckHitKey(KEY_INPUT_ESCAPE)) {
		StopSoundMem(Main_Bgm);
		endFlag = true;
		nextSceneID = 2;  // GameOverSceneに移動
	}

	//// プレイヤー死亡エフェクト用
	//if (!isDeathEffectActive) {
	//	isDeathEffectActive = true;
	//	deathEffectFrame = 0;
	//	// プレイヤーの中心に合わせる
	//	effectX = playerRect.x + playerRect.w / 2 - deathEffectFrameW / 2;
	//	effectY = playerRect.y + playerRect.h / 2 - deathEffectFrameH / 2;
	//}
	//
	//// 死亡エフェクトの進行
	//if (isDeathEffectActive) {
	//	// 1フレームごとにアニメーション進行
	//	int totalFrames = deathEffectCols * deathEffectRows; // 9コマ
	//	int currentFrame = (deathEffectFrame / 5) % totalFrames; // 5フレームごと切替
	//
	//	int srcX = (currentFrame % deathEffectCols) * deathEffectFrameW;
	//	int srcY = (currentFrame / deathEffectCols) * deathEffectFrameH;
	//
	//	DrawRectGraph(
	//		effectX - scrollX, effectY,
	//		srcX, srcY,
	//		deathEffectFrameW, deathEffectFrameH,
	//		deathEffectImg, TRUE
	//	);
	//}
	//
	// プレイヤー死亡エフェクト開始
	//if (player.IsDead() && !isDeathEffectActive) {
	//	isDeathEffectActive = true;
	//	deathEffectFrame = 0;
	//	// プレイヤーの中心に配置
	//	effectX = playerRect.x + playerRect.w / 2 - deathEffectFrameW / 2;
	//	effectY = playerRect.y + playerRect.h / 2 - deathEffectFrameH / 2;
	//}
	//
	//// エフェクトフレームを進める（描画はしない）
	//if (isDeathEffectActive) {
	//	int totalFrames = deathEffectCols * deathEffectRows;
	//	if (deathEffectFrame < totalFrames * 5 - 1) {
	//		deathEffectFrame++;
	//	}
	//}

}

void GameScene::Draw() {

	// 背景描画
	if (backgroundImage >= 0) {

		DrawBox(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT, GetColor(50, 150, 170), TRUE);

		//int bgOffsetY = -100;  // 上に100pxオフセット

		// 背景をスクロールに応じて描画（ループ表示例）
		int bgWidth, bgHeight;

		SetDrawBlendMode(DX_BLENDMODE_ALPHA, 128);

		GetGraphSize(backgroundImage, &bgWidth, &bgHeight);

		int bgX = -(int(scrollX) % bgWidth);
		for (int x = bgX; x < SCREEN_WIDTH; x += bgWidth) {
			DrawGraph(x, 0/*bgOffsetY*/, backgroundImage, TRUE);
		}
		SetDrawBlendMode(DX_BLENDMODE_NOBLEND, 0);
	}

	// 敵描画
	for (const auto& enemy : enemies) {
		bool isOnScreen =
			enemy.rect.x + enemy.rect.w > scrollX &&
			enemy.rect.x < scrollX + SCREEN_WIDTH &&
			enemy.rect.y + enemy.rect.h > 0 &&
			enemy.rect.y < SCREEN_HEIGHT;

		if (!isOnScreen && enemy.type != 2) continue;

		enemy.Draw(scrollX, enemyImages[enemy.type]);
		//enemy.Update(blocks, enemies, player.GetRect(), scrollX);
	}

	// ブロック描画
	for (const auto& block : blocks) {
		block.Draw(scrollX);
	}

	// アイテム描画
	for (size_t i = 0; i < items.size(); ++i) {
		if (!itemCollected[i]) {
			const auto& item = items[i];
			DrawExtendGraph(
				item.rect.x - scrollX, item.rect.y,
				item.rect.x + item.rect.w - scrollX, item.rect.y + item.rect.h,
				itemImages[item.type], TRUE);
		}
	}

	// プレイヤーが生きていれば描画（当たり判定と一致させる）
	if (!player.IsDead()) {
		player.Draw(scrollX);
	}

	// フェードアウト描画
	if (isGoalFade) {
		SetDrawBlendMode(DX_BLENDMODE_ALPHA, fadeAlpha);
		DrawBox(0, 0, SCREEN_WIDTH, SCREEN_HEIGHT, GetColor(0, 0, 0), TRUE);
		SetDrawBlendMode(DX_BLENDMODE_NOBLEND, 0);
	}

	// 死亡中はプレイヤーを描画せず、エフェクトを表示
	if (isDeathEffectActive) {
		// 1フレームごとにアニメーション進行
		int totalFrames = deathEffectCols * deathEffectRows; // 9コマ
		int currentFrame = (deathEffectFrame / 5) % totalFrames; // 5フレームごと切替

		int srcX = (currentFrame % deathEffectCols) * deathEffectFrameW;
		int srcY = (currentFrame / deathEffectCols) * deathEffectFrameH;

		DrawRectGraph(
			effectX - scrollX, effectY,
			srcX, srcY,
			deathEffectFrameW, deathEffectFrameH,
			deathEffectImg, TRUE
		);
	}

	SetFontSize(70);
	//DrawString(10, 10, "←→:移動 SPACE:ジャンプ ESC:終了", GetColor(255, 255, 255));
	//DrawString(10, 50, ("壁の数: " + std::to_string(blocks.size())).c_str(), GetColor(255, 255, 255));
	DrawFormatString(120, 20, GetColor(255, 255, 255), " %06d", score);
	//DrawFormatString(20, 50, GetColor(255, 255, 255), "SCORE: %06d", score);
	
	SetFontSize(50);

	DrawFormatString(560, 15, GetColor(255, 255, 0), " %d", (int)timeLimit);
	//DrawFormatString(560, 20, GetColor(255, 255, 0), "TIME: %d", (int)timeLimit);
	
	DrawFormatString(1180, 15, GetColor(0, 255, 0), "×%d", playerLives);
	//DrawFormatString(1100, 20, GetColor(0, 255, 0), "LIVES: %d", playerLives);

	SetFontSize(20);

	// スコア表示
	DrawGraph(0, 0, UI_Score, TRUE);
	
	// 残機表示
	DrawGraph(0, 0, UI_Player_Lives, TRUE);
	//DrawFormatString(uiX + 120, uiY + 70, GetColor(255, 255, 255), "x %d", player.GetLives());

	// タイマー表示
	DrawGraph(0, 0, UI_Timer, TRUE);
	//DrawFormatString(uiX + 120, uiY + 130, GetColor(255, 255, 255), "%03d", (int)timeLimit);

	//// 体力/満腹度バー（例：スコアの下に表示）
	//DrawGraph(0, 0, UI_Bar_Case, TRUE);
}

bool GameScene::IsEnd() {
	return endFlag;
}

int GameScene::NextScene() {
	return nextSceneID; //nextSceneID を返す
}

void GameScene::SetDeltaTime(float dt)
{
	deltaTimeForUpdate = dt;
}

bool GameScene::CheckCollision(const Rect& a, const Rect& b) {
	return !(a.x + a.w <= b.x ||
		a.x >= b.x + b.w ||
		a.y + a.h <= b.y ||
		a.y >= b.y + b.h);
}   
